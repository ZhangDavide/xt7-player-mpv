' Gambas class file

'Copyright (C) 2007, 2008 Antonio Orefice
' Gambas class file

Public Sub Start()
  Dim helpmsg As String

  global.init()
  helpmsg &= "\n" & File.Name(Application.Args[0]) & " "
  helpmsg &= "[options] [file|protocol://]"
  
  Args.begin(helpmsg)
    Try global.arg_profile_default = Args.get("P", "profile-default", ("Use the specified profile as default"), "profilename")
    Try global.arg_profile = Args.get("p", "profile-temp", ("Use specified profile only for this session"), "profilename")
    Try global.arg_append = Args.Has("a", "append", ("Append the file to the playlist of a running instance"))
    Try global.arg_new_instance = Args.Has("n", "new-instance", ("Play in a new instance even if one is already running"))
    Try global.arg_debug = Args.Has("v", "verbose", ("Enable debug output"))
  Try global.arg_file = Args.end()[0]
  
  If (global.arg_file <> "") And Left(global.arg_file) <> "/" Then
    'convert relative to absolute path
    If Not ((global.arg_file Like "*://*") Or (global.arg_file Like "*://")) Then
      global.arg_file = Application.Dir & "/" & global.arg_file
    Endif
  Endif
  
  If global.arg_profile <> "" Then 
    global.myDebug("Will switch profile to: " & global.arg_profile)
  Endif
  If global.arg_profile_default <> "" Then 
    global.myDebug("Will switch and set default profile: " & global.arg_profile_default)
  Endif
  If global.arg_append Then 
    global.myDebug("Will append instead of play")
    If global.arg_file = "" Then
      global.myDebug("but no URI has been provided!")
      Quit
    Endif
    
    Stop
    Try Sock_Append(global.arg_file)
    Quit
  Endif
  If global.arg_file <> "" Then
    global.myDebug("The file to open is " & global.arg_file)
  Endif
  
  Try Global.Center(Fmain, Me)
  FMain.maininit()

End





Public Sub Form_Open()
  'Start()
End

Public MyCSock As Socket

Public Sub Sock_Append(URI As String)
  Dim sBuf As String
  MyCSock = New Socket
  MyCSock.path = global.SocketFile
  MyCSock.Port = Net.Local
  MyCSock.Connect()
  While (MyCSock.Status <> 7) And (MyCSock.Status > 0)
    Wait 0.1
  Wend
  If MyCSock.Status = 7 Then
    sBuf = "append " & URI & "\n"
    Write #MyCSock, sBuf, Len(sBuf)
    Close #MycSock
  Endif
End

Public Sub Sock_Play(URI As String)
  Dim sBuf As String
  MyCSock = New Socket
  MyCSock.path = global.SocketFile
  MyCSock.Port = Net.Local
  MyCSock.Connect()
  While (MyCSock.Status <> 7) And (MyCSock.Status > 0)
    Wait 0.1
  Wend
  If MyCSock.Status = 7 Then
    sBuf = "play " & URI & "\n"
    Write #MyCSock, sBuf, Len(sBuf)
    Close #MycSock
  Endif
End

Public Sub VSplit1_Resize()
  If Not FMain.mplayer.getP("audioonly") Then
    FMain.CorrectAreaAspect()
    fmain.TimerHideShowVideo.start
  Endif
End

Public Sub LabelPanel_MouseDown()
  PanelNowNext.hide
End

Public Sub NowPanel_MouseDown()
  'PanelNowNext.hide
  ShowHidePinfo()
End

Public Sub NextPanel_MouseDown()
  'PanelNowNext.hide
  ShowHidePinfo()
End

Public Sub buttonepg_MouseDown()
  global.Center(fmain, epgform)
  EpgForm.Show()
  PanelNowNext.hide
  epgform.ScrollToChannel(Replace(fmain.mplayer.getP("fullpath"), "dvb://", ""))
End




Public Sub ShowHidePinfo()
  LabelNowInfo.visible = Not LabelNowInfo.visible  
  LabelNextInfo.visible = Not LabelNextInfo.visible
  Fmain.PanelNowNextArrange(LabelNextInfo.visible)
End

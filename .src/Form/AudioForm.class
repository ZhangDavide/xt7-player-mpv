' Gambas class file


Public CoverSize As Integer = 180
Public CSTEP As Integer = 8


Public Sub init()

  GridUp.columns.count = 2
  GridUp.rows.count = 6
  GridUp[0, 0].text = "Artist"
  GridUp[1, 0].text = "Album"
  GridUp[2, 0].text = "Year"
  GridUp[3, 0].text = "Title"
  GridUp[4, 0].text = "Comment"
  GridUp[5, 0].text = "Lyrics"
  GridUp[5, 1].picture = Picture["icon:/22/microphone"]
  GridUp.Columns[0].w = -1
  GridUp.Columns[1].w = -1
  
  GridDown.columns.count = 2
  GridDown.rows.count = 5
  GridDown[0, 0].text = "Radio"
  GridDown[1, 0].text = "Name"
  GridDown[2, 0].text = "Length"
  GridDown[3, 0].text = "Size"
  GridDown[4, 0].text = "Audio Info"
  
  GridDown.Columns[0].w = -1
  GridDown.Columns[1].w = -1
  coverpanel.w = coversize
  CoverBox.h = CoverBox.w 
  
End

Public Sub UpdateLength(length As String)
  
  GridDown[2, 1].text = length
  
End

Public Sub AudioAreaGroup_Drop()

  FMain.VideoAreaGroup_Drop()
End

Public Sub AudioAreaGroup_MouseDrag()
  
  FMain.VideoAreaGroup_MouseDrag()
  
End

Public Sub AudioAreaGroup_MouseDown()
  FMain.VideoAreaGroup_MouseDown()
End


Public Sub AudioAreaGroup_KeyPress()
  
  FMain.VideoAreaGroup_KeyPress()
  
End

Public Sub AudioAreaGroup_MouseUp()
  FMain.VideoAreaGroup_MouseUp()
End

Public Sub AudioAreaGroup_MouseWheel()
  
  FMain.VideoAreaGroup_MouseWheel()
  
End

Public Sub AudioAreaGroup_DblClick()
  
  FMain.VideoAreaGroup_DblClick()
  
End

Public Sub AudioAreaGroup_Enter()
  'Debug picturebox1.handle
  AudioPanel.setfocus()
  
End

Public Sub CoverBox_Enter()

  Last.Border = border.Plain

End

Public Sub CoverBox_Leave()

  Last.border = border.none

End

Public Sub CoverBox_MouseDown()
  FMain.CoverBox_DblClick()
End


Public Sub TimerZoomIn_Timer()
  TimerZoomOut.stop
  If CoverBox.w < Coversize Then
    If CoverBox.w + CSTEP > coversize Then
      CoverBox.Resize(Coversize, Coversize)
        Else
      CoverBox.Resize(CoverBox.w + CSTEP, CoverBox.h + CSTEP)
      CoverBox.visible = True
    Endif
      Else
    TimerZoomin.STOP
  Endif
End

Public Sub TimerZoomOut_Timer()
    TimerZoomin.stop
    If CoverBox.w >= 0 Then
      If CoverBox.w - CSTEP < 0 Then
        CoverBox.Resize(0, 0)
        CoverBox.visible = False
          Else
        CoverBox.Resize(CoverBox.w - Cstep, CoverBox.h - Cstep)
      Endif
        Else
      TimerZoomout.STOP
      CoverBox.visible = False
  Endif
End

Public Function cutstring(mystr As String, MaxL As Integer) As String
  Dim tmpsplit As String
  If Len(mystr) > MaxL Then
    tmpsplit = Left(mystr, MaxL)
    If (Trim(Left(tmpsplit, RInStr(tmpsplit, "]"))) <> "") Then tmpsplit = Left(tmpsplit, RInStr(tmpsplit, "]"))
    If (Trim(Left(tmpsplit, RInStr(tmpsplit, "-"))) <> "") Then tmpsplit = Left(tmpsplit, RInStr(tmpsplit, "-"))
    mystr = Left(tmpsplit, RInStr(tmpsplit, " ")) & "..."
  Endif
  Return mystr
End

Public Sub cutstrings()
  audioform.GridDown[0, 1].text = cutstring(audioform.GridDown[0, 1].text, 50)
End


Public Sub Form_Open()

  

End

Public Sub AudioAreaGroup_MouseMove()

  FMain.VideoAreaGroup_MouseMove()
End

'mpv 0.11 removed af_export filter :(
' Public Sub BarBox_MouseDown()
'   Try FMain.mymeters.nextvis()
' End

Public Sub PictureBox2_Enter()
  
End
Public Sub PictureBox2_leave()
  'Last.border = False
End

Public Sub PictureBox2_MouseDown()
  If Trim(FMain.mplayer.getP("Artist")) = "" Or Trim(FMain.mplayer.getP("title")) = "" Then
    Message.Error(("Missing Artist and/or Song information"))
    Return
  Endif
  FormLyrics.Searchlyrics(FMain.mplayer.getP("artist"), FMain.mplayer.getP("title"))
End



Public Sub Label17_MouseDown()
  PictureBox2_MouseDown()
End

Public Sub AudioAreaGroup_Arrange()
  pictureback.lower
  pictureback.Move(0, 0, audiopanel.w, AudioPanel.h - picturebox1.h)
End

Public Sub ShowBackground()
  Dim blurred As Image
  Dim gradient As Image
  Dim t As Image
  Dim pw, ph, cw, ch As Integer
  Dim max_light As Integer = 150 'normalize bright images to this value
  Dim max_light_down As Integer = 75 'normalize bright images to this value
  Dim mean As Integer
  
  pictureback.lower
  pictureback.background = Color.black
  
  gradient = Image.Load("shadeaudiopanel.png") '.Mirror(False, True)
  
  'take the background from the current cover
  blurred = CoverBox.Picture.Image
  
  'get a good blur effect without using gb.image.effects by resizing the image multiple times.
  'it works!
  blurred = blurred.Stretch(10, 10)
  blurred = blurred.Stretch(5, 5)
  blurred = blurred.Stretch(10, 10)
  blurred = blurred.Stretch(5, 5)
  blurred = blurred.Stretch(10, 10)
  blurred = blurred.Stretch(5, 5)
  
  blurred = blurred.Stretch(gradient.w, gradient.h)
  
  'normalize brightness
  mean = c_mean(blurred)
  If mean > max_light Then
    blurred = blurred.Brightness(- (1 - (max_light / mean)))
  Endif
  
  'compose the alpha mask gradient over the blurred image  
   blurred.PaintImage(gradient, 0, 0)
  
  pictureback.picture = blurred.picture
  pictureback.show



'   If mean > max_light_down Then
'     picturebox1.Background = Color.black
'     picturebox1.picture = pictureback.Picture.Image.Stretch(2, 32).Mirror(False, True).Brightness(- (1 - (max_light_down / mean))).picture
'       Else
'     picturebox1.picture = pictureback.Picture.Image.Stretch(2, 32).Mirror(False, True).picture
'   Endif
'   ' t = pictureback.Picture.Image.Stretch(1, 1).Stretch(16, 256)
'   ' picturebox1.Picture.Image.PaintImage(t, 0, 0)
' 'pictureback.Picture.Image.Stretch(1, 1).picture


End

Private Function c_mean(img As Image) As Integer
Dim i, s As Integer
Dim skiprows As Integer = img.Pixels.count Div 8
'an imprecise color mean
  For i = skiprows To img.Pixels.Count - skiprows Step 3
    s += Color[img.Pixels[i]].value
  Next
  Return CInt(s / (img.Pixels.count - (skiprows * 2))) * 3
End


Public Sub audioareagroup_Click()
  If Lower(Last.name) = "gridup" Then
    If GridUp.row = 5 Then 
      PictureBox2_MouseDown()
    Endif
  Endif
End

' Gambas class file

Create Static

Public Struct Xoutput
  output_name As String
  mode_name As String
  w As Integer
  h As Integer
  x As Integer
  y As Integer
  r As Float
End Struct

Public Function get_sizes() As String[]
  'given an output name, returns a string[] as follows:
  '[outputname|modename|w|h|refresh],..,[outputname|modename|w|h|refresh]'
  Dim xrandr_output, a, b As String 
  Dim output_name As String
  Dim xrandr_output_splitted As String[]
  Dim tmp As String[]
  Dim i, j, k As Integer
  Dim aLine, bLine As String
  Dim modename, w, h, r As String
  Dim return_value As New String[]
  Dim mode As String
  Dim modes As New String[]
  
  Shell "xrandr --verbose --current" To xrandr_output
  xrandr_output_splitted = Split(xrandr_output, "\n", "", True)
  
  For i = 0 To xrandr_output_splitted.max 'search output_name
    aLine = xrandr_output_splitted[i] 
    If aLine Like "* connected *" Then output_name = Split(aline, " ", "", True)[0]

        If aLine Like "* (*) *Hz*HSync*VSync*" Then 'found the first modeline"
          modename = Split(aLine, " ", "", True)[0]
          a = xrandr_output_splitted[i + 1]
          b = xrandr_output_splitted[i + 2]

          w = Split(a, " ", "", True)[2]
          h = Split(b, " ", "", True)[2]

          tmp = Split(b, " ", "", True)
          r = Replace(tmp[tmp.max], "Hz", "", gb.IgnoreCase)

          mode = output_name & "|" & modename & "|" & w & "|" & h & "|" & r
          modes.Add(mode)
        Endif
  Next 'i
  
  Return modes
  
End


Public Function output_from_screen(s As Screen) As Xoutput
  'returns the display output name, resolution and refreshrate of the specified gb screen
  Dim xrandr_output As String
  Dim aLine, element, mode_name As String
  Dim xrandr_output_splitted As String[]
  Dim splitted As String[]
  Dim output_name, w, h, x, y As String
  Dim r As Float = -1
  Dim Xreturn As Xoutput
  Dim i, j As Integer

  Shell "xrandr --current" To xrandr_output
  xrandr_output_splitted = Split(xrandr_output, "\n", "", True)
  
  For i = 0 To xrandr_output_splitted.max
    'walk through xrandr lines, search For connected outputs
    aLine = xrandr_output_splitted[i]
    
    If InStr(aLine, " connected ") > 0 Then
      aLine = Replace(aLine, "primary ", "")
      splitted = Split(aLine, " x+", "", True)
      w = splitted[2]
      h = splitted[3]
      x = splitted[4]
      y = splitted[5]
      If s.w = w Then
        If s.h = h Then
          If s.x = x Then
            If s.y = y Then
              'screen match found
              output_name = splitted[0]
              'extract the refresh. find "*"
              For j = i + 1 To xrandr_output_splitted.max
                aLine = xrandr_output_splitted[j]
                If InStr(aLine, "*") > 0 Then
                  'found the mode, search which refresh ends with "*"
                  For Each element In Split(aLine, " ", "", True)
                    Try r = CFloat(Split(element, "*", "", True)[0])
                    If Not Error Then
                      mode_name = Split(aLine, " ", "", True)[0]
                      Break
                    Endif
                  Next
                Endif
                If r <> -1 Then Break
              Next
              Xreturn = New Xoutput
              Xreturn.output_name = output_name
              Xreturn.mode_name = mode_name
              Xreturn.w = w
              Xreturn.h = h
              Xreturn.r = r
              Goto returnlabel
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

  returnlabel:
  Return Xreturn

End


Private Function Screenbypos(x As Integer, y As Integer) As Screen
  Dim s As Screen
  For Each s In Screens
    If (x >= s.x) And x <= (s.x + s.W) Then
      If (y >= s.y) And y <= (s.y + s.h) Then
        Return s
      Endif
    Endif
  Next
  
  'no screen found !? repeat with more tolerance:
  For Each s In Screens
    If (x + 50 >= s.x) And x <= (s.x + s.W + 50) Then
      If (y + 50 >= s.y) And y <= (s.y + s.h + 50) Then
        Return s
      Endif
    Endif
  Next

  'still no screen found? return the first.
  global.myDebug("Couldn 't get the matching screen (!)")
  Return Screens[0]
End

Public Sub Xoutput_from_obj(o As Object) As Xoutput
  'return on which screen ( output_name) is the center of the object o
  Dim s As Screen
  Dim out As Xoutput
  s = Screenbypos(o.screenx + (o.w Div 2), o.screeny + (o.h Div 2))
  Return output_from_screen(s)
End

Public Sub change_mode(output_name As String, mode As String, r As Float)
  Shell "xrandr --output " & output_name & " --mode " & mode & " --rate " & r
End





Public Sub test()
  'given an output-name
  'given a source resolution
  'given the source fps
  
  'search for a mode that
  '* has the same aspect ratio of the source resolution +/- 5%
  '* has a resolution >= than the source resolution
  '* has a refresh rate multiple of the (requested fps +/- 5%)

  Dim modes_db As New String[] ' '[outputname|modename|w|h|refresh],..,[outputname|modename|w|h|refresh]'
  Dim mode As String
  Dim mode_name As String
  Dim s_output_name As String = "DVI-I-3"
  Dim s_w As Integer = 1280
  Dim s_h As Integer = 720
  Dim s_fps As Float = 23.976

  Dim w, h As Integer
  Dim r As Float
  Dim i As Integer
  
  modes_db = get_sizes()

  For Each mode In modes_db
    If Split(mode, "|", "", True)[0] = s_output_name Then
      mode_name = Split(mode, "|", "", True)[1] 
      w = CInt(Split(mode, "|", "", True)[2])
      h = CInt(Split(mode, "|", "", True)[3])
      r = CFloat(Split(mode, "|", "", True)[4])
'      If Abs((w / h) - (s_w / s_h)) < (w / h) * 0.05 Then
'        Mod
'      Endif
    Endif
  Next
  

End

